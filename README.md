Author: Rubén Chuliá Mena <rubchume@gmail.com>

# Installation of packages
The application needs to be executed in an environment with Python 3.8 installed.

If this is the case, proceed with the installation of necessary packages. Open the CLI (Command Line Interface) and execute:
```bash
pip install -r requirements.txt
```

# Execution
Execute the command 
```bash
jupyter notebook
```
to open the Jupyter Notebook and see how to use the program.

# Test
Test the application with Pytest using
```bash
python -m pytest
```

# Use your own AWS Lambda function
In order to setup a Lambda function in AWS, you must complete several steps.

First, create an account.

Then, create a user with administrator permissions so you don't use your root user (which can handle very sensitive information and operations).
Follow the steps in [here](https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_create-admin-group.html).

AWS will generate a csv file with the credentials for that user (i.e. private and public keys).
Associate that those credentials to a profile locally. Follow the steps in [here](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html)
and [here](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html).

Once done, follow the instructions from this [repository](https://github.com/awsdocs/aws-lambda-developer-guide/tree/main/sample-apps/blank-python)
to develop a Lambda function locally and then push it to AWS.

## Create bucket for artifacts
According to the instructions in that repository, the first task is to create a bucket to store the artifacts generated by the function.
The command is
```shell script
aws s3 mb s3://<bucket_name> --profile <profile_name>
```

You can just execute the script `aws_deployment/1_create_aws_bucket.sh` from the `aws_deployment` folder.

## Package Python distribution
The second step is to create a Python distribution with all the required packages. This is like creating a virtual environment,
but in this case you control where it is located with the `--target` flag in the `pip install -r requirements.txt` command.

You can just execute the script `aws_deployment/2_build_layer.sh`.

## Deploy in AWS
The third step is to deploy.

We divide this task into two steps:
- Uploading the necessary files to the previously created bucket
- Deploying the Lambda function

In order to do this comfortably, AWS has an API called [Cloudformation](https://docs.aws.amazon.com/cloudformation/index.html)
that allows you to define the infrastructure you want with a simple YAML template file. It is what is known as infrastructure as code.
Consult the AWS CLI CloudFormation command reference (`aws cloudformation ...`) in [here](https://docs.aws.amazon.com/cli/latest/reference/cloudformation/index.html).

The template is situated in `aws_deployment/cloudformation_template.yml`.
There are some parameters that refer to local locations, like the `aws_deployment/package` location.
Those are the ones that must be uploaded to the bucket.
You can do it with the command `aws cloudformation package`.
It will upload the files and then it will create another cloudformation template file with the locations changed from local to the bucket locations.

The deployment is done with the `aws cloudformation deploy` command.

You can execute both tasks with `aws_deployment/3_deploy.sh`.
